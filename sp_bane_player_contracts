



/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

Procedure Name:	stage_player_contracts
Author:			Corey Krawiec
Creation Date:	06/03/2016
Description:       

	This program is for creating new Player Contract tables

	1)	Create a transactions table that includes nfl club ids and flags disapproved contracts
	2)	Find voided contract years and remove them to get real contract money
	3)	Create basic contract summary table and add in a running 'true extension' count
	4)  Adjust contracts for 5th year options that are picked up.
		
	
Input Parameters:
	None
	
Output Parameters:
	None 

Modifications:
Date		SE				Description
11/24/2017	Corey Krawiec	Finds contract with voided years and takes those years out (v2)
10/09/2018	Corey Krawiec	Added step to find early money and make sure it is counted for the true value of contracts with voided years

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(1) - a


	Create a master transactions table with bane club ids

	OUTPUT TABLES:
	#temp_transactions

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_transactions exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_transactions') IS NOT NULL
		DROP TABLE #temp_transactions

	SELECT transid AS transaction_id
		,PlayerID AS nfl_player_id
		,dtLoadDate AS load_date
		,Season AS season
		,TransactionDate AS transaction_date
		,ToDate AS to_date
		,OrderBy AS order_by
		,TransactionDesc AS transaction_description
		,TransactionDescAbbr AS transaction_abbreviation
		,TransStatus AS transaction_status
		,InitialTransStatusDescAbbr AS initial_status_abbreviation
		,InitialTransStatusShortDesc AS initial_status_description_short
		,InitialTransStatusDesc AS initial_status_description
		,ResultTransStatusDescAbbr AS result_status_abbreviation
		,ResultTransStatusShortDesc AS result_status_description_short
		,ResultTransStatusDesc AS result_status_description
		,PcmsContractID AS pcms_contract_id
		,Comments1 AS comments_1
		,Comments2 AS comments_2	
		,sc.id AS start_club_bane_id
		,rc.id AS result_club_bane_id
		,pc.id AS potential_club_bane_id	
		,potentialClubAbbr 
	INTO #temp_transactions
	FROM ProDB.dbo.TransactionTable tt
	LEFT JOIN BaneProductionAnalytics.dbo.clubs rc
		ON LTRIM(RTRIM(tt.ResultClubAbbr)) = LTRIM(RTRIM(rc.code))
	LEFT JOIN BaneProductionAnalytics.dbo.clubs sc
		ON LTRIM(RTRIM(tt.StartClubAbbr)) = LTRIM(RTRIM(sc.code))
	LEFT JOIN BaneProductionAnalytics.dbo.clubs pc
		ON LTRIM(RTRIM(tt.PotentialClubAbbr)) = LTRIM(RTRIM(pc.code))
	WHERE 1=1
		AND LeagueType = 'NFL'
		AND TransStatus = 30
	ORDER BY PlayerID
		,OrderBy DESC


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(1) - b


	Flag disapproved contracts

	OUTPUT TABLES:
	#temp_disappoved_contracts

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_disapproved_contracts exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_disapproved_contracts') IS NOT NULL
		DROP TABLE #temp_disapproved_contracts

	SELECT *
		,CASE WHEN transaction_abbreviation IN ('CO03','CO05','CO06','CO07') 
			OR (LAG(transaction_abbreviation) OVER (ORDER BY nfl_player_id, order_by DESC) IN ('CO03','CO05','CO06','CO07')
			AND (UPPER(transaction_abbreviation) LIKE '%FA%' OR transaction_abbreviation IN ('SS01','SI99')))
		THEN 1 
		ELSE 0 
		END AS flag_disapproved_contract
	INTO #temp_disapproved_contracts
	FROM #temp_transactions


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(1) - c


	Create the nfl transactions table.

	OUTPUT TABLES:
	#temp_transactions_nfl

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_transactions_nfl exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_transactions_nfl') IS NOT NULL
		DROP TABLE #temp_transactions_nfl

	SELECT *
		,CASE WHEN LAG(flag_disapproved_contract) OVER (ORDER BY nfl_player_id, order_by) = 0 AND flag_disapproved_contract = 1 THEN 0
			WHEN flag_disapproved_contract = 1 THEN 1
			WHEN flag_disapproved_contract = 0 THEN 0 
		END AS flag_disapproved_contract_match
	INTO #temp_transactions_nfl
	FROM #temp_disapproved_contracts
	ORDER BY nfl_player_id
		,order_by


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(2) - a


	Create a list of all contracts with voided seasons

	OUTPUT TABLES:
	#temp_void_seasons

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_void_seasons exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_void_seasons') IS NOT NULL
		DROP TABLE #temp_void_seasons
	
	SELECT DISTINCT ContractID AS nfl_contract_id
		,Season AS season
	INTO #temp_void_seasons
	FROM [ClubDB].[dbo].[SectionYearRep]
	WHERE SectionType = 'Void Year'


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(2) - b


	Create a table that notes early cash. Like Flacco in 2012, that cash was really for 2013 but was paid before end of league year.

	TEMP TABLES:
		#temp_early_cash

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_signing_bonus_lag exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_signing_bonus_lag') IS NOT NULL
		DROP TABLE #temp_signing_bonus_lag

	SELECT PlayerID AS nfl_player_id
		  ,cap.Season AS season
		  ,cap.Season + 1 AS season_to_move_cash_to
		  ,ClubID AS nfl_club_id
		  ,LAG(ClubID) OVER (PARTITION BY PlayerID, ClubID ORDER BY cap.Season, COALESCE(ToDate,'12/31/2099')) as nfl_club_id_previous
		  ,FromDate AS from_date
		  ,ToDate AS to_date
		  ,regular_season_end
		  ,LAG(CashSB_SB) OVER (PARTITION BY PlayerID, ClubID ORDER BY cap.Season, COALESCE(ToDate,'12/31/2099')) as signing_bonus_previous_record
		  ,CashSB_SB AS signing_bonus
		  ,LAG(CashSB_Option) OVER (PARTITION BY PlayerID, ClubID ORDER BY cap.Season, COALESCE(ToDate,'12/31/2099')) as option_bonus_previous_record
		  ,CashSB_Option AS option_bonus
		  ,LAG(CashLTBE_RB) OVER (PARTITION BY PlayerID, ClubID ORDER BY cap.Season, COALESCE(ToDate,'12/31/2099')) as roster_bonus_previous_record
		  ,CashLTBE_RB AS roster_bonus
	INTO #temp_signing_bonus_lag
	FROM ClubDB.dbo.CapRollup cap
	INNER JOIN Analytics.dbo.map_nfl_league_year_dates ld
		ON cap.Season = ld.season
	WHERE cap.Season >= 2011
	ORDER BY PlayerID
		,Season

	-- Check if #temp_early_cash exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_early_cash') IS NOT NULL
		DROP TABLE #temp_early_cash

	SELECT nfl_player_id
		  ,season
		  ,season_to_move_cash_to
		  ,nfl_club_id
		  ,from_date
		  ,to_date
		  ,signing_bonus - signing_bonus_previous_record AS early_cash_signing_bonus
		  ,option_bonus - option_bonus_previous_record AS early_cash_option_bonus
		  ,roster_bonus - roster_bonus_previous_record AS early_cash_roster_bonus
	INTO #temp_early_cash
	FROM #temp_signing_bonus_lag
	WHERE from_date >= regular_season_end
		AND ((signing_bonus - signing_bonus_previous_record) > 0
			OR (option_bonus - option_bonus_previous_record) > 0
			OR (roster_bonus - roster_bonus_previous_record) > 0)
		AND nfl_club_id_previous = nfl_club_id

 /*
 SELECT *
 FROM #temp_early_cash
 WHERE nfl_player_id = 26250
 ORDER BY nfl_club_id, Season, COALESCE(To_Date,'12/31/2099')
 */

/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(2) - c


	Join the voided seasons to the cap and contract data

	OUTPUT TABLES:
	#temp_cap_contract_to_void

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_cap_contract_to_void exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_cap_contract_to_void') IS NOT NULL
		DROP TABLE #temp_cap_contract_to_void

	SELECT ContractID AS nfl_contract_id
		,cap.Season AS season
		,RANK() OVER (PARTITION BY con.ContractID ORDER BY cap.season) AS contract_season
		,cap.Cash + ISNULL(early_cash_signing_bonus,0) + ISNULL(early_cash_option_bonus,0) + ISNULL(early_cash_roster_bonus,0) AS cash
		,cap.CashP5 AS p5
		,cap.CashSB_SB + ISNULL(early_cash_signing_bonus,0) AS signing_bonus
		,cap.CashSB_Option + ISNULL(early_cash_option_bonus,0) AS option_bonus
		,cap.CashLTBE_RB + ISNULL(early_cash_roster_bonus,0) AS roster_bonus
	INTO #temp_cap_contract_to_void
	FROM ClubDB.dbo.CapRollup cap
	INNER JOIN ClubDB.dbo.ContractRep con
		ON cap.PlayerID = con.PlayerID
		AND cap.FromDate = con.SignDate
		AND cap.Season BETWEEN con.FirstContractYear AND con.LastContractYear
	LEFT JOIN #temp_early_cash ec
		ON cap.PlayerID = ec.nfl_player_id
		AND cap.ClubID = ec.nfl_club_id
		AND cap.FromDate = ec.from_date
		AND cap.Season = ec.season_to_move_cash_to

/*
select *
from #temp_cap_contract_to_void
where nfl_contract_id = 227413
*/


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(2) - d

	Create a table to sum up the real money of contracts with void seasons.

	OUTPUT TABLES:
	#temp_contracts_cash_exclude_voids

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_contracts_cash_exclude_voids exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_contracts_cash_exclude_voids') IS NOT NULL
		DROP TABLE #temp_contracts_cash_exclude_voids

	SELECT cv.nfl_contract_id
		,SUM(CASE WHEN vs.nfl_contract_id IS NULL THEN cash ELSE 0 END) AS total_cash
		,SUM(CASE WHEN vs.nfl_contract_id IS NULL THEN p5 ELSE 0 END) AS total_p5
		,SUM(CASE WHEN vs.nfl_contract_id IS NULL AND contract_season IN (1,2,3) THEN cash ELSE 0 END) AS total_three_year_cash
		,SUM(CASE WHEN vs.nfl_contract_id IS NULL THEN signing_bonus ELSE 0 END) AS total_signing_bonus
		,SUM(CASE WHEN vs.nfl_contract_id IS NULL THEN roster_bonus ELSE 0 END) AS total_roster_bonus
		,SUM(CASE WHEN vs.nfl_contract_id IS NULL THEN option_bonus ELSE 0 END) AS total_option_bonus
		,MIN(CASE WHEN vs.nfl_contract_id IS NULL THEN cv.season ELSE NULL END) AS first_contract_year
		,MAX(CASE WHEN vs.nfl_contract_id IS NULL THEN cv.season ELSE NULL END) AS last_contract_year
	INTO #temp_contracts_cash_exclude_voids
	FROM #temp_cap_contract_to_void cv
	LEFT JOIN #temp_void_seasons vs
		ON cv.nfl_contract_id = vs.nfl_contract_id
		AND cv.season = vs.season
	WHERE cv.nfl_contract_id IN (SELECT DISTINCT nfl_contract_id FROM #temp_void_seasons)
	GROUP BY cv.nfl_contract_id

/*
select *
from #temp_contracts_cash_exclude_voids
where nfl_contract_id = 227396
*/

/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(3) - a


	Create a temp version of the league's contract table that fixes the contracts with void years.

	Note even though the vairable actual_last_contract_year would make more sense to be calculated in the
	next step with all the others like it, you need it for the generation of the variable new_money_first_contract_year
	so you do it in this step instead.

	OUTPUT TABLES:
	#temp_contract_rep

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_contract_rep exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_contract_rep') IS NOT NULL
		DROP TABLE #temp_contract_rep

	SELECT cr.*
		,CASE WHEN ev.nfl_contract_id IS NOT NULL THEN ev.last_contract_year 
			WHEN LTRIM(RTRIM(SigningType)) IN ('Selection List Signing','Undrafted Rookie Signing') AND pl.draft_round = 1 AND draft_year >= 2013 THEN LastContractYear - 1 
			ELSE LastContractYear 
		END AS last_contract_year
		,CASE WHEN ev.total_cash IS NOT NULL THEN ev.total_cash ELSE TotalPackageAmt END AS total_package_amount
		,CASE WHEN ev.total_p5 IS NOT NULL THEN ev.total_p5 ELSE TotalP5 END AS total_p5
		,CASE WHEN ev.total_three_year_cash IS NOT NULL THEN ev.total_three_year_cash ELSE ThreeYearComp END AS three_year_compensation
		,CASE WHEN ev.total_signing_bonus IS NOT NULL THEN ev.total_signing_bonus ELSE TotalSigningBonus END AS total_signing_bonus
		,CASE WHEN ev.total_option_bonus IS NOT NULL THEN ev.total_option_bonus ELSE TotalOption END AS total_option_bonus
		,CASE WHEN ev.total_roster_bonus IS NOT NULL THEN ev.total_roster_bonus ELSE TotalRosterBonus END AS total_roster_bonus
		,CASE WHEN COALESCE(LEAD(FirstContractYear) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate) - 1,last_contract_year) >= FirstContractYear THEN COALESCE(LEAD(FirstContractYear) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate)- 1,last_contract_year) 
			ELSE COALESCE(LEAD(FirstContractYear) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate),last_contract_year) 
		END AS actual_last_contract_year
	INTO #temp_contract_rep
	FROM ClubDb.dbo.ContractRep cr
	LEFT JOIN #temp_contracts_cash_exclude_voids ev
		ON cr.ContractID = ev.nfl_contract_id
	INNER JOIN BaneProductionAnalytics.dbo.players pl
		ON cr.PlayerID = pl.nfl_id
		AND pl.is_deleted = 0
	WHERE LastContractYear >= 2005
		AND LTRIM(RTRIM(SigningType)) NOT IN ('Reserve, Selection List'
			,'Reserve/Selection List'
			,'Qualifying Offer by Old Club'
			,'Practice Squad'
			,'Received Minimum Salary Offer'
			,'Practice Squad Exception'
			,'Signed New Contract (pd-->pd)'
			,'Offer Sheet Executed'
			,'Designated Transition Player'
			,'Asked to Re-Sign'
			,'Contract Tolled'
			,'Designated Franchise Player'
			,'Reserve/Supplemental Selection'
			,'Signed, Renegotiated Practice Squad Contact'
			,'Signed, Renegotiated Practice Squad Contract'
			)

/*
SELECT *
FROM #temp_contract_rep
*/


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(3) - b


	Create the basic contract summary table.

	OUTPUT TABLES:
	#temp_player_contract_summary_basic

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_player_contract_summary_basic exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_player_contract_summary_basic') IS NOT NULL
		DROP TABLE #temp_player_contract_summary_basic

	SELECT ContractRepId AS nfl_contract_rep_id
		,LAG(ContractRepId) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate) AS previous_nfl_contract_rep_id
		,ContractID AS nfl_contract_id
		,LAG(ContractID) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate) AS previous_nfl_contract_id
		,PlayerID AS nfl_player_id
		,CONCAT(Player_LastName,', ',Player_FootballName) AS player
		,AgentID AS nfl_agent_id
		,ClubID AS nfl_club_id
		,LAG(ClubID) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate) AS previous_nfl_club_id
		,TransID AS nfl_transaction_id
		,SignDate AS signing_date
		,LEAD(SignDate) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate) AS signing_date_next_contract
		,LTRIM(RTRIM(SigningType)) AS signing_type
		,CASE WHEN LTRIM(RTRIM(SigningType)) IN ('Selection List Signing','Undrafted Rookie Signing') THEN 1 ELSE 0 END AS rookie_contract
		,CASE WHEN ISNULL(LAG(last_contract_year,1) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate),0) < FirstContractYear THEN 0 
			WHEN LTRIM(RTRIM(SigningType)) NOT IN ('Renegotiation/Extension') THEN 0
			ELSE 1
		END AS true_extension
		,FirstContractYear AS first_contract_year
		,COALESCE(LAG(actual_last_contract_year) OVER (PARTITION BY cr.PlayerID ORDER BY SignDate) + 1,FirstContractYear) AS new_money_first_contract_year
		,last_contract_year
		,actual_last_contract_year
		,last_contract_year - FirstContractYear + 1 AS total_years
		,total_package_amount
		,total_package_amount / (last_contract_year - FirstContractYear + 1) AS total_average_per_year
		,three_year_compensation
		,CASE WHEN (last_contract_year - FirstContractYear + 1) >= 3 THEN three_year_compensation / 3 ELSE three_year_compensation / (last_contract_year - FirstContractYear + 1) END AS three_year_average_per_year
		,total_p5
		,total_p5 / (last_contract_year - FirstContractYear + 1) AS p5_average_per_year
		--,CASE WHEN TotalSigningBonus = 0 AND SigningType = 'Selection List Signing' THEN TotalOption ELSE TotalSigningBonus END AS total_signing_bonus
		,total_signing_bonus
		,total_roster_bonus
		,total_option_bonus
		,TotalReportingBonus AS total_reporting_bonus
		,TotalIncentives AS total_incentives
		,TotalOffseason AS total_offseason_bonus
		,HTMLFileName AS html_file_name
		,ContractEnteredSystem AS system_entry_date
		,EffectiveContract AS effective_contract
		,MostRecentContract AS most_recent_contract
		,MinSalaryBenefitContract AS is_minimum_salary_benefit_contract
		,RANK() OVER (PARTITION BY PlayerID ORDER BY SignDate, TransID) AS contract_record_count
		,RANK() OVER (PARTITION BY PlayerID, FirstContractYear ORDER BY SignDate) AS same_season_contract_count
	INTO #temp_player_contract_summary_basic
	FROM #temp_contract_rep cr
	ORDER BY PlayerID
		,SignDate


/*
SELECT * 
FROM #temp_player_contract_summary_basic
WHERE player = 'Roethlisberger, Ben'
ORDER BY signing_date
*/

/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(3) - c


	Count up how many extensions a player has on each 'deal' (can have multiple teams on the same deal). This is kind
	of complicated, so it needs multiple steps. First, you need to create a temp table that notes when the last non true
	extension was for a player for each given row.  You need the counter to be able to reset to 0 if a player signs a contract
	that isn't a true extension in the middle, so in the next step you just count the true_extensions going
	backwards to that date.  

	OUTPUT TABLES:
	#temp_player_contract_recent_non_extension
	#temp_player_contract_with_extension_count

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_player_contract_recent_non_extension exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_player_contract_recent_non_extension') IS NOT NULL
		DROP TABLE #temp_player_contract_recent_non_extension

	SELECT c1.*
		,(SELECT MAX(signing_date) 
			FROM #temp_player_contract_summary_basic c2
			WHERE c2.nfl_player_id = c1.nfl_player_id
				AND c2.signing_date <= c1.signing_date
				AND c2.true_extension = 0)
		AS recent_non_extension
	INTO #temp_player_contract_recent_non_extension
	FROM #temp_player_contract_summary_basic c1


	-- Check if #temp_player_contract_with_extension_count exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_player_contract_with_extension_count') IS NOT NULL
		DROP TABLE #temp_player_contract_with_extension_count

	SELECT r1.*
		,CASE WHEN LTRIM(RTRIM(signing_type)) = 'Renegotiation/Extension' THEN 
			(SELECT SUM(true_extension) 
			FROM #temp_player_contract_recent_non_extension r2
			WHERE r2.nfl_player_id = r1.nfl_player_id
				AND r2.signing_date <= r1.signing_date
				AND r2.signing_date >= r1.recent_non_extension
				)
		ELSE 0
		END AS extension_count
	INTO #temp_player_contract_with_extension_count
	FROM #temp_player_contract_recent_non_extension r1


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(4) - a


	Create the table that gets you the 5th year option amount so you can add it in to 
	the yearly compensation if it is picked up for a given player.

	OUTPUT TABLES:
	#temp_fifth_year_option

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_fifth_year_option exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_fifth_year_option') IS NOT NULL
		DROP TABLE #temp_fifth_year_option

	SELECT DISTINCT ContractRepID
		,syr.ContractID
		,syr.SectionID
		,syr.Season
		,SectionType
		,ClauseType
		,Guar_Cap AS fifth_year_option_amount
	INTO #temp_fifth_year_option
	FROM ClubDB.dbo.SectionYearRep syr
	INNER JOIN ClubDB.dbo.CapGuarantee cg
		ON syr.SectionID = cg.ChangingSectionID
		AND syr.Season = cg.Season 
		AND cg.Effective = 1
		AND cg.Finalized = 1
		--AND cg.Guar_Cap > 0
	WHERE SectionType = 'Option Year'


/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	(4) - b

	Create the table that has the yearly Cash Breakdown of contracts. Join in the 
	5th year option amounts where applicable.

	You include the WHERE clause because sometimes there are "fake" contract years in the
	ContractYearRep table, namely when early cash is paid out (see Joe Flacco). His second
	contract has a row for 2012 in ContractYearRep (because that's when his early cash was
	paid), but the actual contract started in 2013.

	OUTPUT TABLES:
	#temp_contract_year_breakdown

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_contract_year_breakdown exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_contract_year_breakdown') IS NOT NULL
		DROP TABLE #temp_contract_year_breakdown

	SELECT cy.ContractRepID AS nfl_contract_rep_id
		,cy.ContractID AS nfl_contract_id
		,previous_nfl_contract_rep_id
		,previous_nfl_contract_id
		,new_money_first_contract_year
		,cr.nfl_player_id
		,cy.Season AS season
		,CASE WHEN fifth_year_option_amount IS NOT NULL THEN fifth_year_option_amount ELSE AnnualFullP5 + AnnualReportingBonus + AnnualRosterBonus END AS annual_compensation
	--INTO #temp_contract_year_breakdown
	FROM ClubDB.dbo.ContractYearRep cy
	INNER JOIN #temp_player_contract_with_extension_count cr
		ON cy.ContractRepID = cr.nfl_contract_rep_id
		AND cy.ContractID = cr.nfl_contract_id
	LEFT JOIN #temp_fifth_year_option fyo
		ON cy.ContractRepID = fyo.ContractRepID
		AND cy.ContractID = fyo.ContractID
		AND cy.Season = fyo.Season
	WHERE cy.Season >= first_contract_year 



/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Join the previous contract to the newer contract

	OUTPUT TABLES:
	#temp_contract_year_breakdown_with_prev

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_contract_year_breakdown_with_prev exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_contract_year_breakdown_with_prev') IS NOT NULL
		DROP TABLE #temp_contract_year_breakdown_with_prev

    SELECT new.nfl_contract_rep_id
		  ,new.nfl_contract_id
		  ,new.previous_nfl_contract_rep_id
		  ,new.previous_nfl_contract_id
		  ,new.new_money_first_contract_year
		  ,new.nfl_player_id
		  ,new.season
		  ,new.annual_compensation AS annual_compensation_new
		  ,old.annual_compensation AS annual_compensation_old
	  INTO #temp_contract_year_breakdown_with_prev
      FROM #temp_contract_year_breakdown new
 LEFT JOIN #temp_contract_year_breakdown old
		ON new.previous_nfl_contract_rep_id = old.nfl_contract_rep_id
	   AND new.previous_nfl_contract_id = old.nfl_contract_id
	   AND new.season = old.season

/*
SELECT *
FROM #temp_contract_year_breakdown_with_prev
WHERE nfl_player_id = 28953
ORDER BY nfl_contract_id, season
*/

/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

Sum up the new and old money in each contract.

OUTPUT TABLES:
#temp_contract_compensation_old_new

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

-- Check if #temp_contract_compensation_old_new exists, if it does drop it
IF OBJECT_ID('tempdb..#temp_contract_compensation_old_new') IS NOT NULL
	DROP TABLE #temp_contract_compensation_old_new

    SELECT nfl_contract_rep_id
		  ,nfl_contract_id
		  ,nfl_player_id
		  ,SUM(annual_compensation_new) AS total_compensation_new
		  ,SUM(annual_compensation_old) AS total_compensation_old
	  INTO #temp_contract_compensation_old_new
      FROM #temp_contract_year_breakdown_with_prev
  GROUP BY nfl_contract_rep_id
		  ,nfl_contract_id
		  ,nfl_player_id

/*
SELECT *
FROM #temp_contract_compensation_old_new
WHERE nfl_player_id = 33099
ORDER BY nfl_contract_id
*/

/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

Join the old and new money values into the basic contract table

OUTPUT TABLES:
#temp_player_contract_summary

----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

-- Check if #temp_player_contract_summary exists, if it does drop it
IF OBJECT_ID('tempdb..#temp_player_contract_summary') IS NOT NULL
	DROP TABLE #temp_player_contract_summary

    SELECT cs.*
		  ,COALESCE(total_signing_bonus,0) + COALESCE(total_option_bonus,0) + COALESCE(total_compensation_new,0) - COALESCE(total_compensation_old,0) AS new_money
		  ,(COALESCE(total_signing_bonus,0) + COALESCE(total_option_bonus,0) + COALESCE(total_compensation_new,0) - COALESCE(total_compensation_old,0)) / NULLIF(effective_last_contract_year - new_money_first_contract_year + 1,0) AS new_money_average_per_year
		  ,(effective_last_contract_year - new_money_first_contract_year + 1) AS new_money_years
	  --INTO #temp_player_contract_summary
      FROM #temp_player_contract_summary_basic cs
 LEFT JOIN #temp_contract_compensation_old_new con
		ON cs.nfl_contract_rep_id = con.nfl_contract_rep_id
	   AND cs.nfl_contract_id = con.nfl_contract_id
INNER JOIN BaneProductionAnalytics.dbo.players pl
		ON cs.nfl_player_id = pl.nfl_id
INNER JOIN BaneProductionAnalytics.dbo.positions po
		ON pl.position_id = po.id
	 WHERE current_club_id IS NOT NULL
	   AND translation = 'QB'

/*
SELECT *
FROM #temp_player_contract_summary
WHERE player = 'Flacco, Joe'
ORDER BY nfl_contract_id
*/
