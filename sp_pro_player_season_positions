USE [Analytics]
GO

/****** Object:  StoredProcedure [dbo].[sp_analysis_players_season_position_offense]    Script Date: 5/16/2022 2:49:18 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER procedure [dbo].[sp_analysis_players_season_position_offense] (@iSeason INT, @oReturnCD INT OUTPUT) as

/*********************************************************************************

Procedure Name:	sp_analysis_players_season_position_offense
Author:			Corey Krawiec
Creation Date:	8/11/2017
Description:       


	This program is to assign a position and role for a player for the season.

	For each season, the player's row will have his various snap percentages and what we determine 
	is his final season position.

	To come up with a season position for a player we count the position
	he played most often.	

	(1) Count up and rank snaps by position
	(2) Count up and rank snaps by receiver type
	(3) Combine the position and receiver type and snap counts into an analysis_ table

Input Parameters:
	iSeason
	
Output Parameters:
	None 

Modifications:
Date         SE           Description

**********************************************************************************/

BEGIN 

	set @oReturnCD = 0 



	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------


	(1)
	
	First find a season position for every offensive player.

	Sum up snaps by position for each player.

	OUTPUT TABLES:
	#temp_position_snap_counts_season_all

	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_position_snap_counts_season_all exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_position_snap_counts_season_all') IS NOT NULL
		DROP TABLE #temp_position_snap_counts_season_all

	SELECT nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,an.season
		,an.season_type_adjusted
	----------Overall Position Counts
		,SUM(CASE WHEN position_blt = 'QB' THEN 1 ELSE 0 END) AS [QB]
		,SUM(CASE WHEN position_blt = 'RB' THEN 1 ELSE 0 END) AS [RB]
		,SUM(CASE WHEN position_blt = 'FB' THEN 1 ELSE 0 END) AS [FB]
		,SUM(CASE WHEN position_blt = 'LT' THEN 1 ELSE 0 END) AS [LOT]
		,SUM(CASE WHEN position_blt = 'LG' THEN 1 ELSE 0 END) AS [LOG]
		,SUM(CASE WHEN position_blt = 'OC' THEN 1 ELSE 0 END) AS [OC]
		,SUM(CASE WHEN position_blt = 'RG' THEN 1 ELSE 0 END) AS [ROG]
		,SUM(CASE WHEN position_blt = 'RT' THEN 1 ELSE 0 END) AS [ROT]
		,SUM(CASE WHEN position_blt = 'TE' THEN 1 ELSE 0 END) AS [TE]
		,SUM(CASE WHEN position_blt = 'WR' THEN 1 ELSE 0 END) AS [WR]
	INTO #temp_position_snap_counts_season_all
	FROM [Analytics].[dbo].[stage_plays_player_offensive_alignment] pos
	INNER JOIN [Analytics].[dbo].[stage_plays_play_type] pt
		ON pos.pff_play_id=pt.pff_play_id
	INNER JOIN [Analytics].[dbo].[stage_plays_play_ancillary] an
		ON pos.pff_play_id=an.pff_play_id
	WHERE an.season >= @iSeason
		AND is_no_play = 0 
		AND is_qb_kneel = 0
		AND is_qb_spike = 0
	GROUP BY nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,an.season
		,an.season_type_adjusted



	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Unpivot the snaps table so you have a different row for each position a player has snaps at.

	OUTPUT TABLES:
	#temp_position_snap_counts_season_unpivot_all

	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_position_snap_counts_season_unpivot_all exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_position_snap_counts_season_unpivot_all') IS NOT NULL
		DROP TABLE #temp_position_snap_counts_season_unpivot_all

	SELECT nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,season
		,season_type_adjusted
		,position_counts.position_blt
		,position_counts.snap_count
	INTO #temp_position_snap_counts_season_unpivot_all
	FROM #temp_position_snap_counts_season_all
	UNPIVOT (snap_count FOR position_blt IN (QB,RB,FB,LOT,[LOG],OC,ROG,ROT,TE,WR)) AS position_counts



	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Rank the snap counts - the highest one is the player's season position.

	OUTPUT TABLES:
	#temp_position_snap_counts_season_rank_all

	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_position_snap_counts_season_rank_all exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_position_snap_counts_season_rank_all') IS NOT NULL
		DROP TABLE #temp_position_snap_counts_season_rank_all

	SELECT nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,season
		,season_type_adjusted
		,position_blt
		--,snap_count
		,RANK() OVER (PARTITION BY nfl_player_id, season, season_type_adjusted ORDER BY snap_count DESC, position_blt) AS snap_count_order
	INTO #temp_position_snap_counts_season_rank_all
	FROM #temp_position_snap_counts_season_unpivot_all
	WHERE snap_count > 0


	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Create the final Player Season position table.

	OUTPUT TABLES:
	#temp_seasons_position_off

	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_seasons_position_off exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_seasons_position_off') IS NOT NULL
		DROP TABLE #temp_seasons_position_off

	SELECT a.nfl_player_id
		,a.season
		,a.season_type_adjusted
		,position_blt
		,[QB] AS snap_count_qb
		,[RB] AS snap_count_rb
		,[FB] AS snap_count_fb
		,[LOT] AS snap_count_lot
		,[LOG] AS snap_count_log
		,[OC] AS snap_count_oc	
		,[ROG] AS snap_count_rog	
		,[ROT] AS snap_count_rot
		,[TE] AS snap_count_te
		,[WR] AS snap_count_wr
	INTO #temp_seasons_position_off
	FROM #temp_position_snap_counts_season_rank_all a
	INNER JOIN #temp_position_snap_counts_season_all ca
		ON a.nfl_player_id = ca.nfl_player_id
		AND a.season = ca.season
		AND a.season_type_adjusted = ca.season_type_adjusted
	WHERE snap_count_order=1


	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	
	(2)
	
	Now find a season receiver type for every offensive player.

	Sum up snaps by receiver type for each player.

	OUTPUT TABLES:
	#temp_type_snap_counts_season_all

	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_type_snap_counts_season_all exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_type_snap_counts_season_all') IS NOT NULL
		DROP TABLE #temp_type_snap_counts_season_all

	SELECT nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,an.season
		,an.season_type_adjusted
		----------Overall Type Counts
		,SUM(CASE WHEN LTRIM(RTRIM(UPPER(receiver_type))) = 'FLEX' THEN 1 ELSE 0 END) AS [type_flex]
		,SUM(CASE WHEN LTRIM(RTRIM(UPPER(receiver_type))) = 'INSIDE' THEN 1 ELSE 0 END) AS [type_inside]
		,SUM(CASE WHEN LTRIM(RTRIM(UPPER(receiver_type))) = 'SLOT' THEN 1 ELSE 0 END) AS [type_slot]
		,SUM(CASE WHEN LTRIM(RTRIM(UPPER(receiver_type))) = 'WIDE' THEN 1 ELSE 0 END) AS [type_wide]
	INTO #temp_type_snap_counts_season_all
	FROM [Analytics].[dbo].[stage_plays_player_offensive_alignment] pos
	INNER JOIN [Analytics].[dbo].[stage_plays_play_type] pt
		ON pos.pff_play_id=pt.pff_play_id
	INNER JOIN [Analytics].[dbo].[stage_plays_play_ancillary] an
		ON pos.pff_play_id=an.pff_play_id
	WHERE an.season >= @iSeason
		AND is_no_play = 0 
		AND is_qb_kneel = 0
		AND is_qb_spike = 0	
	GROUP BY nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,an.season
		,an.season_type_adjusted


	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Unpivot the types table so you have a different row for each receiver type a player has snaps at.

	OUTPUT TABLES:
	#temp_type_snap_counts_season_unpivot_all

	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_type_snap_counts_season_unpivot_all exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_type_snap_counts_season_unpivot_all') IS NOT NULL
		DROP TABLE #temp_type_snap_counts_season_unpivot_all

	SELECT nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,season
		,season_type_adjusted
		,position_counts.receiver_type
		,position_counts.snap_count
	INTO #temp_type_snap_counts_season_unpivot_all
	FROM #temp_type_snap_counts_season_all
	UNPIVOT (snap_count FOR receiver_type IN (type_flex,type_inside,type_slot,type_wide)) AS position_counts


	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Rank the snap counts - the highest one is the player's season receiver type.

	OUTPUT TABLES:
	#temp_type_snap_counts_season_rank_all

	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_type_snap_counts_season_rank_all exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_type_snap_counts_season_rank_all') IS NOT NULL
		DROP TABLE #temp_type_snap_counts_season_rank_all

	SELECT nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,season
		,season_type_adjusted
		,receiver_type
		--,snap_count
		,RANK() OVER (PARTITION BY nfl_player_id, season, season_type_adjusted ORDER BY snap_count DESC, receiver_type) AS snap_count_order
	INTO #temp_type_snap_counts_season_rank_all
	FROM #temp_type_snap_counts_season_unpivot_all
	WHERE snap_count > 0


	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------

	Create the final Player Season role table

	OUTPUT TABLES:
	#temp_seasons_receiver_type

	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Check if #temp_seasons_receiver_type exists, if it does drop it
	IF OBJECT_ID('tempdb..#temp_seasons_receiver_type') IS NOT NULL
		DROP TABLE #temp_seasons_receiver_type

	SELECT ra.nfl_player_id
		,ra.season
		,ra.season_type_adjusted
		,CASE WHEN receiver_type = 'type_flex' THEN 'FLEX'
			WHEN receiver_type = 'type_inside' THEN 'INSIDE'
			WHEN receiver_type = 'type_slot' THEN 'SLOT'
			WHEN receiver_type = 'type_wide' THEN 'WIDE'
			ELSE NULL
		END AS receiver_type
		,[type_flex] AS snap_count_flex
		,[type_inside] AS snap_count_inside
		,[type_slot] AS snap_count_slot
		,[type_wide] AS snap_count_wide
	INTO #temp_seasons_receiver_type
	FROM #temp_type_snap_counts_season_rank_all ra
	INNER JOIN #temp_type_snap_counts_season_all cb
		ON ra.nfl_player_id = cb.nfl_player_id
		AND ra.season = cb.season
		AND ra.season_type_adjusted = cb.season_type_adjusted
	WHERE snap_count_order=1


	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------


	(3)

	Combine position and receiver type into one table.

	ANALYSIS TABLES:
		analysis_players_season_position_offense
		
	----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

	-- Clear data from the analysis_players_season_position_offense table 
	DELETE FROM analysis_players_season_position_offense
	WHERE season >= @iSeason

	INSERT INTO analysis_players_season_position_offense
		([nfl_player_id]
		,[season]
		,[season_type_adjusted]
		,[position_blt]
		,[snap_count_qb]
		,[snap_count_rb]
		,[snap_count_fb]
		,[snap_count_lot]
		,[snap_count_log]
		,[snap_count_oc]
		,[snap_count_rog]
		,[snap_count_rot]
		,[snap_count_te]
		,[snap_count_wr]
		,[receiver_type]
		,[snap_count_flex]
		,[snap_count_inside]
		,[snap_count_slot]
		,[snap_count_wide]
		,[snap_count_all])
	SELECT po.nfl_player_id
		--,team --not sure if we want to separate it out by team...if a guy plays different positions for different teams do we want to recognize that?
		,po.season
		,po.season_type_adjusted
		,CASE WHEN pp.translation = 'TE' AND position_blt = 'WR' THEN 'TE'
			ELSE position_blt
		END AS position_blt
		,snap_count_qb
		,snap_count_rb
		,snap_count_fb
		,snap_count_lot
		,snap_count_log
		,snap_count_oc	
		,snap_count_rog	
		,snap_count_rot
		,snap_count_te	
		,snap_count_wr
		,CASE WHEN pp.translation = 'TE' AND position_blt = 'WR' THEN 
				CASE WHEN snap_count_slot + snap_count_wide > snap_count_inside THEN 'SLOT'
						WHEN snap_count_flex > snap_count_inside THEN 'FLEX'
						ELSE receiver_type
				END
			ELSE receiver_type
		END AS receiver_type
		,snap_count_flex
		,snap_count_inside
		,snap_count_slot
		,snap_count_wide
		,(snap_count_qb + snap_count_rb + snap_count_fb + snap_count_lot + snap_count_log + snap_count_oc + snap_count_rog + snap_count_rot + snap_count_te + snap_count_wr) AS snap_count_all
	FROM #temp_seasons_position_off po
	LEFT JOIN #temp_seasons_receiver_type rt
		ON po.nfl_player_id = rt.nfl_player_id
		AND po.season = rt.season
		AND po.season_type_adjusted = rt.season_type_adjusted
	INNER JOIN BaneProductionAnalytics.dbo.players pl
		ON po.nfl_player_id = pl.nfl_id
		AND pl.is_deleted = 0
	INNER JOIN BaneProductionAnalytics.dbo.positions pp
		ON pl.position_id = pp.id
	WHERE pp.team IN ('offense') 
		AND po.season >= @iSeason

	PROC_END:

	RETURN @oReturnCD  

END










GO


